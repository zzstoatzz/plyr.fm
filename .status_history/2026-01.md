# plyr.fm Status History - January 2026

## Early January 2026 Work (Jan 1-9)

### multi-account experience (PRs #707, #710, #712-714, Jan 3-5)

**why**: many users have multiple ATProto identities (personal, artist, label). forcing re-authentication to switch was friction that discouraged uploads from secondary accounts.

**users can now link multiple identities** to a single browser session:
- add additional accounts via "add account" in user menu (triggers OAuth with `prompt=login`)
- switch between linked accounts instantly without re-authenticating
- logout from individual accounts or all at once
- updated `/auth/me` returns `linked_accounts` array with avatars

**backend changes**:
- new `group_id` column on `user_sessions` links accounts together
- new `pending_add_accounts` table tracks in-progress OAuth flows
- new endpoints: `POST /auth/add-account/start`, `POST /auth/switch-account`, `POST /auth/logout-all`

**infrastructure fixes** (PRs #710, #712, #714):
these fixes came from reviewing [Bluesky's architecture deep dive](https://newsletter.pragmaticengineer.com/p/bluesky) which highlighted connection/resource management as scaling concerns. applied learnings to our own codebase:
- identified Neon serverless connection overhead (~77ms per connection) via Logfire
- cached `async_sessionmaker` per engine instead of recreating on every request (PR #712)
- changed `_refresh_locks` from unbounded dict to LRUCache (10k max, 1hr TTL) to prevent memory leak (PR #710)
- pass db session through auth helpers to reduce connections per request (PR #714)
- result: `/auth/switch-account` ~1100ms → ~800ms, `/auth/me` ~940ms → ~720ms

**frontend changes**:
- UserMenu (desktop): collapsible accounts submenu with linked accounts, add account, logout all
- ProfileMenu (mobile): dedicated accounts panel with avatars
- fixed `invalidateAll()` not refreshing client-side loaded data by using `window.location.reload()` (PR #713)

**docs**: [research/2026-01-03-multi-account-experience.md](docs/research/2026-01-03-multi-account-experience.md)

---

### integration test harness (PR #744, Jan 9)

**automated tests running against staging**:
- pure Python audio generation (sine waves, no FFmpeg dependency)
- multi-user test fixtures via `PLYR_TEST_TOKEN_1/2/3` secrets
- track lifecycle tests: upload, edit, delete, search indexing
- cross-user interaction tests: like/unlike, permission boundaries
- GitHub Actions workflow triggers after staging deploy

---

### track edit UX improvements (PRs #741-742, Jan 9)

**why**: the portal track editing experience had several UX issues - users couldn't remove artwork (only replace), no preview when selecting new images, and buttons were poorly styled icon-only squares with overly aggressive hover effects.

**artwork management** (PR #742):
- add ability to **remove track artwork** via new `remove_image` form field on `PATCH /tracks/{id}`
- show **image preview** when selecting new artwork before saving
- hover overlay on current artwork with trash icon to remove
- "undo" option when artwork is marked for removal
- clear status labels: "current artwork", "new artwork selected", "artwork will be removed"

**button styling** (PR #742):
- replace icon-only squares with labeled pill buttons (`edit`, `delete`)
- subtle outlined save/cancel buttons in edit mode
- fix global button hover styles bleeding into all buttons (scoped to form submit only)

**shutdown fix** (PR #742):
- add 2s timeouts to docket worker and service shutdown
- prevents backend hanging on Ctrl+C or hot-reload during development

**beartype fix** (PR #741):
- `starlette.UploadFile` vs `fastapi.UploadFile` type mismatch was causing 500 errors on image upload
- fixed by importing UploadFile from starlette in metadata_service.py

---

### auth stabilization (PRs #734-736, Jan 6-7)

**why**: multi-account support introduced edge cases where auth state could become inconsistent between frontend components, and sessions could outlive their refresh tokens.

**session expiry alignment** (PR #734):
- sessions now track refresh token lifetime and respect it during validation
- prevents sessions from appearing valid after their underlying OAuth grant expires
- dev token expiration handling aligned with same pattern

**queue auth boundary fix** (PR #735):
- queue component now uses shared layout auth state instead of localStorage session IDs
- fixes race condition where queue could attempt authenticated requests before layout resolved auth
- ensures remote queue snapshots don't inherit local update flags during hydration

**playlist cover upload fix** (PR #736):
- `R2Storage.save()` was rejecting `BytesIO` objects due to beartype's strict `BinaryIO` protocol checking
- changed type hint to `BinaryIO | BytesIO` to explicitly accept both
- found via Logfire: only 2 failures in production, both on Jan 3

---

### timestamp deep links (PRs #739-740, Jan 8)

**timestamped comment sharing** (PR #739):
- timed comments now show share button on hover
- copies URL with `?t=` parameter (e.g., `plyr.fm/track/123?t=45`)
- visiting timestamped URL auto-seeks to that position on play

**autoplay error suppression** (PR #740):
- suppress browser autoplay errors when deep linking to timestamps
- browsers block autoplay without user interaction; now fails silently

---

### artist bio links (PRs #700-701, Jan 2)

**links in artist bios now render as clickable** - supports full URLs and bare domains (e.g., "example.com"):
- regex extracts URLs from bio text
- bare domain/path URLs handled correctly
- links open in new tab

---

### copyright moderation improvements (PRs #703-704, Jan 2-3)

**per legal advice**, redesigned copyright handling to reduce liability exposure:
- **disabled auto-labeling** (PR #703): labels are no longer automatically emitted when copyright matches are detected. the system now only flags and notifies, leaving takedown decisions to humans
- **raised threshold** (PR #703): copyright flag threshold increased from "any match" to configurable score (default 85%). controlled via `MODERATION_COPYRIGHT_SCORE_THRESHOLD` env var
- **DM notifications** (PR #704): when a track is flagged, both the artist and admin receive BlueSky DMs with details. includes structured error handling for when users have DMs disabled
- **observability** (PR #704): Logfire spans added to all notification paths (`send_dm`, `copyright_notification`) with error categorization (`dm_blocked`, `network`, `auth`, `unknown`)
- **notification tracking**: `notified_at` field added to `copyright_scans` table to track which flags have been communicated

**why this matters**: DMCA safe harbor requires taking action on notices, not proactively policing. auto-labeling was creating liability by making assertions about copyright status. human review is now required before any takedown action.

---

### ATProto OAuth permission sets (PRs #697-698, Jan 1-2)

**permission sets enabled** - OAuth now uses `include:fm.plyr.authFullApp` instead of listing individual `repo:` scopes:
- users see clean "plyr.fm" permission title instead of raw collection names
- permission set lexicon published to `com.atproto.lexicon.schema` on plyr.fm authority repo
- DNS TXT records at `_lexicon.plyr.fm` and `_lexicon.stg.plyr.fm` link namespaces to authority DID
- fixed scope validation in atproto SDK fork to handle PDS permission expansion (`include:` → `repo?collection=`)

**why this matters**: permission sets are ATProto's mechanism for defining platform access tiers. enables future third-party integrations (mobile apps, read-only stats dashboards) to request semantic permission bundles instead of raw collection lists.

**docs**: [lexicons/overview.md](docs/lexicons/overview.md), [research/2026-01-01-atproto-oauth-permission-sets.md](docs/research/2026-01-01-atproto-oauth-permission-sets.md)

---

### atprotofans supporters display (PRs #695-696, Jan 1)

**supporters now visible on artist pages** - artists using atprotofans can show their supporters:
- compact overlapping avatar circles (GitHub sponsors style) with "+N" overflow badge
- clicks link to supporter's plyr.fm artist page (keeps users in-app)
- `POST /artists/batch` endpoint enriches supporter DIDs with avatar_url from our Artist table
- frontend fetches from atprotofans, enriches via backend, renders with consistent avatar pattern

**route ordering fix** (PR #696): FastAPI was matching `/artists/batch` as `/{did}` with did="batch". moved POST route before the catchall GET route.

---

### UI polish (PRs #692-694, Dec 31 - Jan 1)

- **feed/library toggle** (PR #692): consistent header layout with toggle between feed and library views
- **shuffle button moved** (PR #693): shuffle now in queue component instead of player controls
- **justfile consistency** (PR #694): standardized `just run` across frontend/backend modules
