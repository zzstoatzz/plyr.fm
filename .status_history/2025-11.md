# plyr.fm Status History - November-December 2025

## December 2025 Work (Early)

### settings consolidation (PR #496, Dec 6)

**problem**: user preferences were scattered across multiple locations with confusing terminology:
- SensitiveImage tooltip said "enable in portal" but mobile menu said "profile"
- clicking gear icon (SettingsMenu) only showed appearance/playback, not all settings
- portal mixed content management with preferences

**solution**: clear separation between **settings** (preferences) and **portal** (content & data):

| page | purpose |
|------|---------|
| `/settings` | preferences: theme, accent color, auto-advance, sensitive artwork, timed comments, teal.fm, developer tokens |
| `/portal` | your content & data: profile, tracks, albums, export, delete account |

**changes**:
- created dedicated `/settings` route consolidating all user preferences
- slimmed portal to focus on content management
- added "all settings â†’" link to SettingsMenu and ProfileMenu
- renamed mobile menu "profile" â†’ "portal" to match route
- moved delete account to portal's "your data" section (it's about data, not preferences)
- fixed `font-family: inherit` on all settings page buttons
- updated SensitiveImage tooltip: "enable in settings"

---

### bufo easter egg improvements (PRs #491-492, Dec 6)

**what shipped**:
- configurable exclude/include patterns via env vars for bufo easter egg
- `BUFO_EXCLUDE_PATTERNS`: regex patterns to filter out (default: `^bigbufo_`)
- `BUFO_INCLUDE_PATTERNS`: allowlist that overrides exclude (default: `bigbufo_0_0`, `bigbufo_2_1`)
- cache key now includes patterns so config changes take effect immediately

**reusable type**:
- added `CommaSeparatedStringSet` type for parsing comma-delimited env vars into sets
- uses pydantic `BeforeValidator` with `Annotated` pattern (not class-coupled validators)
- handles: `VAR=a,b,c` â†’ `{"a", "b", "c"}`

**context**: bigbufo tiles are 4x4 grid fragments that looked weird floating individually. now excluded by default, with two specific tiles allowed through.

**thread**: https://bsky.app/profile/zzstoatzzdevlog.bsky.social/post/3m7e3ndmgwl2m

---

### mobile artwork upload fix (PR #489, Dec 6)

**problem**: artwork uploads from iOS Photos library silently failed - track uploaded successfully but without artwork.

**root cause**: iOS stores photos in HEIC format. when selected, iOS converts content to JPEG but often keeps the `.heic` filename. backend validated format using only filename extension â†’ rejected as "unsupported format".

**fix**:
- backend now prefers MIME content_type over filename extension for format detection
- added `ImageFormat.from_content_type()` method
- frontend uses `accept="image/*"` for broader iOS compatibility

---

### sensitive image moderation (PRs #471-488, Dec 5-6)

**what shipped**:
- `sensitive_images` table to flag problematic images by R2 `image_id` or external URL
- `show_sensitive_artwork` user preference (default: hidden, toggle in portal â†’ "your data")
- flagged images blurred everywhere: track lists, player, artist pages, likers tooltip, search results, embeds
- Media Session API (CarPlay, lock screen, control center) respects sensitive preference
- SSR-safe filtering: link previews (og:image) exclude sensitive images on track, artist, and album pages
- likers tooltip UX: max-height with scroll, hover interaction fix, viewport-aware flip positioning
- likers tooltip z-index: elevates entire track-container when tooltip open (prevents sibling tracks bleeding through)

**how it works**:
- frontend fetches `/moderation/sensitive-images` and stores flagged IDs/URLs
- `SensitiveImage` component wraps images and checks against flagged list
- server-side check via `+layout.server.ts` for meta tag filtering
- users can opt-in to view sensitive artwork via portal toggle

**coverage** (PR #488):

| context | approach |
|---------|----------|
| DOM images needing blur | `SensitiveImage` component |
| small avatars in lists | `SensitiveImage` with `compact` prop |
| SSR meta tags (og:image) | `checkImageSensitive()` function |
| non-DOM APIs (media session) | direct `isSensitive()` + `showSensitiveArtwork` check |

**moderation workflow**:
- admin adds row to `sensitive_images` with `image_id` (R2) or `url` (external)
- images are blurred immediately for all users
- users who enable `show_sensitive_artwork` see unblurred images

---

### teal.fm scrobbling integration (PR #467, Dec 4)

**what shipped**:
- native teal.fm scrobbling: when users enable the toggle, plays are recorded to their PDS using teal's ATProto lexicons
- scrobble triggers at 30% or 30 seconds (whichever comes first) - same threshold as play counts
- user preference stored in database, toggleable from portal â†’ "your data"
- settings link to pdsls.dev so users can view their scrobble records

**lexicons used**:
- `fm.teal.alpha.feed.play` - individual play records (scrobbles)
- `fm.teal.alpha.actor.status` - now-playing status updates

**configuration** (all optional, sensible defaults):
- `TEAL_ENABLED` (default: `true`) - feature flag for entire integration
- `TEAL_PLAY_COLLECTION` (default: `fm.teal.alpha.feed.play`)
- `TEAL_STATUS_COLLECTION` (default: `fm.teal.alpha.actor.status`)

**code quality improvements** (same PR):
- added `settings.frontend.domain` computed property for environment-aware URLs
- extracted `get_session_id_from_request()` utility for bearer token parsing
- added field validator on `DeveloperTokenInfo.session_id` for auto-truncation
- applied walrus operators throughout auth and playback code
- fixed now-playing endpoint firing every 1 second (fingerprint update bug in scheduled reports)

**documentation**: `backend/src/backend/_internal/atproto/teal.py` contains inline docs on the scrobbling flow

---

### unified search (PR #447, Dec 3)

**what shipped**:
- `Cmd+K` (mac) / `Ctrl+K` (windows/linux) opens search modal from anywhere
- fuzzy matching across tracks, artists, albums, and tags using PostgreSQL `pg_trgm`
- results grouped by type with relevance scores (0.0-1.0)
- keyboard navigation (arrow keys, enter, esc)
- artwork/avatars displayed with lazy loading and fallback icons
- glassmorphism modal styling with backdrop blur
- debounced input (150ms) with client-side validation

**database**:
- enabled `pg_trgm` extension for trigram-based similarity search
- GIN indexes on `tracks.title`, `artists.handle`, `artists.display_name`, `albums.title`, `tags.name`

**documentation**: `docs/frontend/search.md`, `docs/frontend/keyboard-shortcuts.md`

**follow-up polish** (PRs #449-463):
- mobile search icon in header (PRs #455-456)
- theme-aware modal styling with styled scrollbar (#450)
- ILIKE fallback for substring matches when trigram fails (#452)
- tag collapse with +N button (#453)
- input focus fix: removed `visibility: hidden` so focus works on open (#457, #463)
- album artwork fallback in player when track has no image (#458)
- rate limiting exemption for now-playing endpoints (#460)
- `--no-dev` flag for release command to prevent dev dep installation (#461)

---

### light/dark theme and mobile UX overhaul (Dec 2-3)

**theme system** (PR #441):
- replaced hardcoded colors across 35 files with CSS custom properties
- semantic tokens: `--bg-primary`, `--text-secondary`, `--accent`, etc.
- theme switcher in settings: dark / light / system (follows OS preference)
- removed zen mode feature (superseded by proper theme support)

**mobile UX improvements** (PR #443):
- new `ProfileMenu` component â€” collapses profile, upload, settings, logout into touch-optimized menu (44px tap targets)
- dedicated `/upload` page â€” extracted from portal for cleaner mobile flow
- portal overhaul â€” tighter forms, track detail links under artwork, fixed icon alignment
- standardized section headers across home and liked tracks pages

**player scroll timing fix** (PR #445):
- reduced title scroll cycle from 10s â†’ 8s, artist/album from 15s â†’ 10s
- eliminated 1.5s invisible pause at end of scroll animation
- fixed duplicate upload toast (was firing twice on success)
- upload success toast now includes "view track" link

**CI optimization** (PR #444):
- pre-commit hooks now skip based on changed paths
- result: ~10s for most PRs instead of ~1m20s
- only installs tooling (uv, bun) needed for changed directories

---

### tag filtering system and SDK tag support (Dec 2)

**tag filtering** (PRs #431-434):
- users can now hide tracks by tag via eye icon filter in discovery feed
- preferences centralized in root layout (fetched once, shared across app)
- `HiddenTagsFilter` component with expandable UI for managing hidden tags
- default hidden tags: `["ai"]` for new users
- tag detail pages at `/tag/[name]` with all tracks for that tag
- clickable tag badges on tracks navigate to tag pages

**navigation fix** (PR #435):
- fixed tag links interrupting audio playback
- root cause: `stopPropagation()` on links breaks SvelteKit's client-side router
- documented pattern in `docs/frontend/navigation.md` to prevent recurrence

**SDK tag support** (plyr-python-client v0.0.1-alpha.10):
- added `tags: set[str]` parameter to `upload()` in SDK
- added `-t/--tag` CLI option (can be used multiple times)
- updated MCP `upload_guide` prompt with tag examples
- status maintenance workflow now tags AI-generated podcasts with `ai` (#436)

**tags in detail pages** (PR #437):
- track detail endpoint (`/tracks/{id}`) now returns tags
- album detail endpoint (`/albums/{handle}/{slug}`) now returns tags for all tracks
- track detail page displays clickable tag badges

**bufo easter egg** (PR #438):
- tracks tagged with `bufo` trigger animated toad GIFs on the detail page
- uses track title as semantic search query against [find-bufo API](https://find-bufo.fly.dev/)
- toads are semantically matched to the song's vibe (e.g., "Happy Vibes" gets happy toads)
- results cached in localStorage (1 week TTL) to minimize API calls
- `TagEffects` wrapper component provides extensibility for future tag-based plugins
- respects `prefers-reduced-motion`; fails gracefully if API unavailable

---

### queue touch reordering and header stats fix (Dec 2)

**queue mobile UX** (PR #428):
- added 6-dot drag handle to queue items for touch-friendly reordering
- implemented touch event handlers for mobile drag-and-drop
- track follows finger during drag with smooth translateY transform
- drop target highlights while dragging over other tracks

**header stats positioning** (PR #426):
- fixed platform stats not adjusting when queue sidebar opens/closes
- added `--queue-width` CSS custom property updated dynamically
- stats now shift left with smooth transition when queue opens

---

### connection pool resilience for Neon cold starts (Dec 2)

**incident**: ~5 minute API outage (01:55-02:00 UTC) - all requests returned 500 errors

**root cause**: Neon serverless cold start after 5 minutes of idle traffic
- queue listener heartbeat detected dead connection, began reconnection
- first 5 user requests each held a connection waiting for Neon to wake up (3-5 min each)
- with pool_size=5 and max_overflow=0, pool exhausted immediately
- all subsequent requests got `QueuePool limit of size 5 overflow 0 reached`

**fix**:
- increased `pool_size` from 5 â†’ 10 (handle more concurrent cold start requests)
- increased `max_overflow` from 0 â†’ 5 (allow burst to 15 connections)
- increased `connection_timeout` from 3s â†’ 10s (wait for Neon wake-up)

**related**: this is a recurrence of the Nov 17 incident. that fix addressed the queue listener's asyncpg connection but not the SQLAlchemy pool connections.

---

### now-playing API (PR #416, Dec 1)

**what shipped**:
- `GET /now-playing/{did}` and `GET /now-playing/by-handle/{handle}` endpoints
- returns track metadata, playback position, timestamp
- 204 when nothing playing, 200 with track data otherwise

**teal.fm integration**:
- native scrobbling shipped in PR #467 (Dec 4) - plyr.fm writes directly to user's PDS
- Piper integration (external polling) still open: https://github.com/teal-fm/piper/pull/27

---

### admin UI improvements for moderation (PRs #408-414, Dec 1)

**what shipped**:
- dropdown menu for false positive reasons (fingerprint noise, original artist, fair use, other)
- artist/track links open in new tabs for verification
- AuDD score normalization (scores shown as 0-100 range)
- filter controls to show only high-confidence matches
- form submission fixes for htmx POST requests

---

## November 2025 Work

### ATProto labeler and admin UI (PRs #385-395, Nov 29-Dec 1)

**motivation**: integrate with ATProto labeling protocol for proper copyright violation signaling, and improve admin tooling for reviewing flagged content.

**what shipped**:
- **ATProto labeler implementation** (PRs #385, #391):
  - standalone labeler service integrated into moderation Rust service
  - implements `com.atproto.label.queryLabels` and `subscribeLabels` XRPC endpoints
  - k256 ECDSA signing for cryptographic label verification
  - SQLite storage for labels with sequence numbers
  - labels emitted when copyright violations detected
  - negation labels for false positive resolution
- **admin UI** (PRs #390, #392, #395):
  - web interface at `/admin` for reviewing copyright flags
  - htmx for server-rendered interactivity (no inline JS bloat)
  - static files extracted to `moderation/static/` for proper syntax highlighting
  - plyr.fm design tokens for brand consistency
  - shows track title, artist handle, match scores, and potential matches
  - "mark false positive" button emits negation label
- **label context enrichment** (PR #392):
  - labels now include track_title, artist_handle, artist_did, highest_score, matches
  - backfill script (`scripts/backfill_label_context.py`) populated 25 existing flags
  - admin UI displays rich context instead of just ATProto URIs
- **copyright flag visibility** (PRs #387, #389):
  - artist portal shows copyright flag indicator on flagged tracks
  - tooltip shows primary match (artist - title) for quick context
- **documentation** (PR #386):
  - comprehensive docs at `docs/moderation/atproto-labeler.md`
  - covers architecture, label schema, XRPC protocol, signing keys

**admin UI architecture**:
- `moderation/static/admin.html` - page structure
- `moderation/static/admin.css` - plyr.fm design tokens
- `moderation/static/admin.js` - auth handling (~40 lines)
- htmx endpoints: `/admin/flags-html`, `/admin/resolve-htmx`
- server-rendered HTML partials for flag cards

---

### copyright moderation system (PRs #382, #384, Nov 29-30)

**motivation**: detect potential copyright violations in uploaded tracks to avoid DMCA issues and protect the platform.

**what shipped**:
- **moderation service** (Rust/Axum on Fly.io):
  - standalone service at `plyr-moderation.fly.dev`
  - integrates with AuDD enterprise API for audio fingerprinting
  - scans audio URLs and returns matches with metadata (artist, title, album, ISRC, timecode)
  - auth via `X-Moderation-Key` header
- **backend integration** (PR #382):
  - `ModerationSettings` in config (service URL, auth token, timeout)
  - moderation client module (`backend/_internal/moderation.py`)
  - fire-and-forget background task on track upload
  - stores results in `copyright_scans` table
  - scan errors stored as "clear" so tracks aren't stuck unscanned
- **flagging fix** (PR #384):
  - AuDD enterprise API returns no confidence scores (all 0)
  - changed from score threshold to presence-based flagging: `is_flagged = !matches.is_empty()`
  - removed unused `score_threshold` config
- **backfill script** (`scripts/scan_tracks_copyright.py`):
  - scans existing tracks that haven't been checked
  - `--max-duration` flag to skip long DJ sets (estimated from file size)
  - `--dry-run` mode to preview what would be scanned
  - supports dev/staging/prod environments
- **review workflow**:
  - `copyright_scans` table has `resolution`, `reviewed_at`, `reviewed_by`, `review_notes` columns
  - resolution values: `violation`, `false_positive`, `original_artist`

**initial review results** (25 flagged tracks):
- 8 violations (actual copyright issues)
- 11 false positives (fingerprint noise)
- 6 original artists (people uploading their own distributed music)

---

### developer tokens with independent OAuth grants (PR #367, Nov 28)

**motivation**: programmatic API access (scripts, CLIs, automation) needed tokens that survive browser logout and don't become stale when browser sessions refresh.

**what shipped**:
- **OAuth-based dev tokens**: each developer token gets its own OAuth authorization flow
  - user clicks "create token" â†’ redirected to PDS for authorization â†’ token created with independent credentials
  - tokens have their own DPoP keypair, access/refresh tokens - completely separate from browser session
- **cookie isolation**: dev token exchange doesn't set browser cookie
  - added `is_dev_token` flag to ExchangeToken model
  - /auth/exchange skips Set-Cookie for dev token flows
  - prevents logout from deleting dev tokens (critical bug fixed during implementation)
- **token management UI**: portal â†’ "your data" â†’ "developer tokens"
  - create with optional name and expiration (30/90/180/365 days or never)
  - list active tokens with creation/expiration dates
  - revoke individual tokens
- **API endpoints**:
  - `POST /auth/developer-token/start` - initiates OAuth flow, returns auth_url
  - `GET /auth/developer-tokens` - list user's tokens
  - `DELETE /auth/developer-tokens/{prefix}` - revoke by 8-char prefix

**security properties**:
- tokens are full sessions with encrypted OAuth credentials (Fernet)
- each token refreshes independently (no staleness from browser session refresh)
- revokable individually without affecting browser or other tokens
- explicit OAuth consent required at PDS for each token created

**documentation**: see `docs/authentication.md` "developer tokens" section

---

### platform stats and media session integration (PRs #359-379, Nov 27-29)

**motivation**: show platform activity at a glance, improve playback experience across devices, and give users control over their data.

**what shipped**:
- **platform stats endpoint and UI** (PRs #376, #378, #379):
  - `GET /stats` returns total plays, tracks, and artists
  - stats bar displays in homepage header (e.g., "1,691 plays â€¢ 55 tracks â€¢ 8 artists")
  - skeleton loading animation while fetching
  - responsive layout: visible in header on wide screens, collapses to menu on narrow
  - end-of-list animation on homepage
- **Media Session API** (PR #371):
  - provides track metadata to CarPlay, lock screens, Bluetooth devices, macOS control center
  - artwork display with fallback to artist avatar
  - play/pause, prev/next, seek controls all work from system UI
  - position state syncs scrubbers on external interfaces
- **browser tab title** (PR #374):
  - shows "track - artist â€¢ plyr.fm" while playing
  - persists across page navigation
  - reverts to page title when playback stops
- **timed comments** (PR #359):
  - comments capture timestamp when added during playback
  - clickable timestamp buttons seek to that moment
  - compact scrollable comments section on track pages
- **constellation integration** (PR #360):
  - queries constellation.microcosm.blue backlink index
  - enables network-wide like counts (not just plyr.fm internal)
  - environment-aware namespace handling
- **account deletion** (PR #363):
  - explicit confirmation flow (type handle to confirm)
  - deletes all plyr.fm data (tracks, albums, likes, comments, preferences)
  - optional ATProto record cleanup with clear warnings about orphaned references

---

### oEmbed endpoint for Leaflet.pub embeds (PRs #355-358, Nov 25)

**motivation**: plyr.fm tracks embedded in Leaflet.pub (via iframely) showed a black HTML5 audio box instead of our custom embed player.

**what shipped**:
- **oEmbed endpoint** (PR #355): `/oembed` returns proper embed HTML with iframe
  - follows oEmbed spec with `type: "rich"` and iframe in `html` field
  - discovery link in track page `<head>` for automatic detection
- **iframely domain registration**: registered plyr.fm on iframely.com (free tier)
  - this was the key fix - iframely now returns our embed iframe as `links.player[0]`

**debugging journey** (PRs #356-358):
- initially tried `og:video` meta tags to hint iframe embed - didn't work
- tried removing `og:audio` to force oEmbed fallback - resulted in no player link
- discovered iframely requires domain registration to trust oEmbed providers
- after registration, iframely correctly returns embed iframe URL

---

### export & upload reliability (PRs #337-344, Nov 24)

**motivation**: exports were failing silently on large files (OOM), uploads showed incorrect progress, and SSE connections triggered false error toasts.

**what shipped**:
- **database-backed jobs** (PR #337): moved upload/export tracking from in-memory to postgres
  - jobs table persists state across server restarts
  - enables reliable progress tracking via SSE polling
- **streaming exports** (PR #343): fixed OOM on large file exports
  - previously loaded entire files into memory via `response["Body"].read()`
  - now streams to temp files, adds to zip from disk (constant memory)
  - 90-minute WAV files now export successfully on 1GB VM
- **progress tracking fix** (PR #340): upload progress was receiving bytes but treating as percentage
  - `UploadProgressTracker` now properly converts bytes to percentage
  - upload progress bar works correctly again
- **UX improvements** (PRs #338-339, #341-342, #344):
  - export filename now includes date (`plyr-tracks-2025-11-24.zip`)
  - toast notification on track deletion
  - fixed false "lost connection" error when SSE completes normally
  - progress now shows "downloading track X of Y" instead of confusing count

---

### queue hydration + ATProto token hardening (Nov 12)

**why**: queue endpoints were occasionally taking 2s+ and restore operations could 401
when multiple requests refreshed an expired ATProto token simultaneously.

**what shipped**:
- added persistent `image_url` on `Track` rows so queue hydration no longer probes R2
  for every track. Queue payloads now pull art directly from Postgres, with a one-time
  fallback for legacy rows.
- updated `_internal/queue.py` to backfill any missing URLs once (with caching) instead
  of per-request GETs.
- introduced per-session locks in `_refresh_session_tokens` so only one coroutine hits
  `oauth_client.refresh_session` at a time; others reuse the refreshed tokens. This
  removes the race that caused the batch restore flow to intermittently 500/401.

**impact**: queue tail latency dropped back under 500 ms in staging tests, ATProto restore flows are now reliable under concurrent use, and Logfire no longer shows 500s from the PDS.

---

### performance optimization session (Nov 12)

**issue: slow /tracks/liked endpoint**

**symptoms**:
- `/tracks/liked` taking 600-900ms consistently
- only ~25ms spent in database queries
- mysterious 575ms gap with no spans in Logfire traces

**root cause**:
- PR #184 added `image_url` column to tracks table to eliminate N+1 R2 API calls
- legacy tracks (15 tracks uploaded before PR) had `image_url = NULL`
- fallback code called `track.get_image_url()` which makes uninstrumented R2 `head_object` API calls
- 5 tracks Ã— 120ms = ~600ms of uninstrumented latency

**solution**: created `scripts/backfill_image_urls.py` to populate missing `image_url` values

**results**:
- `/tracks/liked` now sub-200ms (down from 600-900ms)
- all endpoints now consistently sub-second response times

**database cleanup**:
- discovered `queue_state` had 265% bloat (53 dead rows, 20 live rows)
- ran `VACUUM (FULL, ANALYZE) queue_state` against production

---

### track detail pages (PR #164, Nov 12)

- âœ… dedicated track detail pages with large cover art
- âœ… play button updates queue state correctly (#169)
- âœ… liked state loaded efficiently via server-side fetch
- âœ… mobile-optimized layouts with proper scrolling constraints
- âœ… origin validation for image URLs (#168)

---

### liked tracks feature (PR #157, Nov 11)

- âœ… server-side persistent collections
- âœ… ATProto record publication for cross-platform visibility
- âœ… UI for adding/removing tracks from liked collection
- âœ… like counts displayed in track responses and analytics (#170)
- âœ… analytics cards now clickable links to track detail pages (#171)
- âœ… liked state shown on artist page tracks (#163)

**status**: COMPLETE (issue #144 closed)

---

### upload streaming + progress UX (PR #182, Nov 11)

- Frontend switched from `fetch` to `XMLHttpRequest` so we can display upload progress
  toasts (critical for >50 MB mixes on mobile).
- Upload form now clears only after the request succeeds; failed attempts leave the
  form intact so users don't lose metadata.
- Backend writes uploads/images to temp files in 8 MB chunks before handing them to the
  storage layer, eliminating whole-file buffering and iOS crashes for hour-long mixes.
- Deployment verified locally and by rerunning the exact repro Stella hit (85 minute
  mix from mobile).

---

### transcoder API deployment (PR #156, Nov 11)

**standalone Rust transcoding service** ðŸŽ‰
- **deployed**: https://plyr-transcoder.fly.dev/
- **purpose**: convert AIFF/FLAC/etc. to MP3 for browser compatibility
- **technology**: Axum + ffmpeg + Docker
- **security**: `X-Transcoder-Key` header authentication (shared secret)
- **capacity**: handles 1GB uploads, tested with 85-minute AIFF files (~858MB â†’ 195MB MP3 in 32 seconds)
- **architecture**:
  - 2 Fly machines for high availability
  - auto-stop/start for cost efficiency
  - stateless design (no R2 integration yet)
  - 320kbps MP3 output with proper ID3 tags
- **status**: deployed and tested, ready for integration into plyr.fm upload pipeline
- **next steps**: wire into backend with R2 integration and job queue (see issue #153)

---

### AIFF/AIF browser compatibility fix (PR #152, Nov 11)

**format validation improvements**
- **problem discovered**: AIFF/AIF files only work in Safari, not Chrome/Firefox
  - browsers throw `MediaError code 4: MEDIA_ERR_SRC_NOT_SUPPORTED`
  - users could upload files but they wouldn't play in most browsers
- **immediate solution**: reject AIFF/AIF uploads at both backend and frontend
  - removed AIFF/AIF from AudioFormat enum
  - added format hints to upload UI: "supported: mp3, wav, m4a"
  - client-side validation with helpful error messages
- **long-term solution**: deployed standalone transcoder service (see above)
  - separate Rust/Axum service with ffmpeg
  - accepts all formats, converts to browser-compatible MP3
  - integration into upload pipeline pending (issue #153)

**observability improvements**:
- added logfire instrumentation to upload background tasks
- added logfire spans to R2 storage operations
- documented logfire querying patterns in `docs/logfire-querying.md`

---

### async I/O performance fixes (PRs #149-151, Nov 10-11)

Eliminated event loop blocking across backend with three critical PRs:

1. **PR #149: async R2 reads** - converted R2 `head_object` operations from sync boto3 to async aioboto3
   - portal page load time: 2+ seconds â†’ ~200ms
   - root cause: `track.image_url` was blocking on serial R2 HEAD requests

2. **PR #150: concurrent PDS resolution** - parallelized ATProto PDS URL lookups
   - homepage load time: 2-6 seconds â†’ 200-400ms
   - root cause: serial `resolve_atproto_data()` calls (8 artists Ã— 200-300ms each)
   - fix: `asyncio.gather()` for batch resolution, database caching for subsequent loads

3. **PR #151: async storage writes/deletes** - made save/delete operations non-blocking
   - R2: switched to `aioboto3` for uploads/deletes (async S3 operations)
   - filesystem: used `anyio.Path` and `anyio.open_file()` for chunked async I/O (64KB chunks)
   - impact: multi-MB uploads no longer monopolize worker thread, constant memory usage

---

### mobile UI improvements (PRs #159-185, Nov 11-12)

- âœ… compact action menus and better navigation (#161)
- âœ… improved mobile responsiveness (#159)
- âœ… consistent button layouts across mobile/desktop (#176-181, #185)
- âœ… always show play count and like count on mobile (#177)
- âœ… login page UX improvements (#174-175)
- âœ… liked page UX improvements (#173)
- âœ… accent color for liked tracks (#160)
