name: backend tests

on:
  pull_request:
    paths:
      - "backend/src/backend/**"
      - "backend/tests/**"
      - "backend/pyproject.toml"
      - "backend/uv.lock"
      - ".github/workflows/test-backend.yml"

permissions:
  contents: read

jobs:
  test:
    timeout-minutes: 10
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_USER: relay_test
          POSTGRES_PASSWORD: relay_test
          POSTGRES_DB: relay_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v5

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "backend/uv.lock"

      - name: install dependencies
        run: cd backend && uv sync --locked

      - name: run tests
        env:
          DATABASE_URL: postgresql+asyncpg://relay_test:relay_test@localhost:5432/relay_test
          DOCKET_URL: redis://localhost:6379
        run: cd backend && uv run pytest tests/ -n auto

      - name: prune uv cache
        if: always()
        run: uv cache prune --ci
