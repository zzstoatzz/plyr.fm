# weekly status maintenance via claude code
#
# two-phase workflow:
# 1. workflow_dispatch: archives old STATUS.md sections, generates audio, opens PR
# 2. on PR merge: uploads audio to plyr.fm
#
# required secrets:
#   ANTHROPIC_API_KEY - claude code
#   GOOGLE_API_KEY - gemini TTS (for audio generation)
#   PLYR_BOT_TOKEN - plyr.fm developer token (for audio upload)

name: status maintenance

on:
  # TODO: restore schedule after testing
  # schedule:
  #   - cron: "0 9 * * 1" # every monday 9am UTC
  workflow_dispatch:
    inputs:
      skip_audio:
        description: "skip audio generation"
        type: boolean
        default: false
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  # phase 1: archive + generate audio + open PR
  maintain:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v4

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Bash"
          prompt: |
            you are maintaining the plyr.fm (pronounce as "player FM") project status file.

            ## context

            - project started: november 2025
            - today's date: run `date` to get current date
            - this may be the first time this workflow has run
            - .status_history/ directory may not exist yet

            ## task 1: gather temporal context

            before writing any transcript, understand the timeline:
            1. run `git log --oneline --since="1 week ago"` to see recent commits
            2. run `git log --oneline -20` to see the last 20 commits with dates
            3. note the actual dates of changes - don't present old work as "just shipped"

            ## task 2: archive old sections (if needed)

            read STATUS.md and count the lines.

            if over 250 lines:
            1. identify natural section boundaries (marked by "---" or headers like "### " with dates)
            2. keep the most recent ~250 lines in STATUS.md
            3. move older sections to .status_history/YYYY-MM.md files, grouped by month
            4. create .status_history/ directory if it doesn't exist
            5. preserve raw content - don't summarize or modify the archived text

            if 250 lines or fewer, skip archiving.

            ## task 3: generate audio overview

            skip_audio input: ${{ inputs.skip_audio }}

            if skip_audio is false:
            1. write a 2-3 minute podcast script to podcast_script.txt
               - two hosts having a casual conversation
               - focus on shipped features from the top of STATUS.md
               - format: "Host: ..." and "Cohost: ..." lines
               - IMPORTANT: "plyr.fm" is pronounced "player FM" (not "plir" or spelling it out)

               temporal awareness:
               - use the git history to understand WHEN things actually shipped
               - if this is the first episode, acknowledge the project started in november 2025
               - reference time correctly: "last week we shipped X" vs "back in november we built Y"
               - don't present month-old work as if it just happened

               tone guidelines:
               - accessible to non-technical listeners, but don't dumb it down
               - focus on user impact: what can people do now that they couldn't before?
               - use intuitive analogies to explain technical concepts in terms of everyday experience
               - matter-of-fact delivery, not hype-y or marketing-speak
               - brief, conversational - like two friends catching up on what shipped

            2. run: uv run scripts/generate_tts.py podcast_script.txt update.wav

            3. delete the podcast script (we only need the audio): rm podcast_script.txt

            4. DO NOT upload to plyr.fm yet - that happens after PR merge

            ## task 4: open PR with changes

            if any files changed (.status_history/*, STATUS.md) OR audio was generated:
            1. create a new branch: git checkout -b status-maintenance-<date>
            2. git add .status_history/ STATUS.md update.wav (do NOT add podcast_script.txt)
            3. commit with message "chore: weekly status maintenance"
            4. push the branch: git push -u origin status-maintenance-<date>
            5. create a PR using: gh pr create --title "chore: weekly status maintenance" --body "automated status archival and audio overview"

            if nothing changed, just report that no maintenance was needed.

        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

  # phase 2: upload audio after PR merge
  upload-audio:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'status-maintenance-')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4

      - name: Upload audio to plyr.fm
        run: |
          if [ -f update.wav ]; then
            uv run --with plyrfm -- plyrfm upload update.wav "plyr.fm update - $(date +'%B %d, %Y')" --album "$(date +%Y)"
          else
            echo "No update.wav found, skipping upload"
          fi
        env:
          PLYR_TOKEN: ${{ secrets.PLYR_BOT_TOKEN }}
