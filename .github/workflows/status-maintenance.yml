# weekly status maintenance via claude code
#
# two-phase workflow:
# 1. workflow_dispatch: archives old STATUS.md sections, generates audio, opens PR
# 2. on PR merge: uploads audio to plyr.fm
#
# required secrets:
#   ANTHROPIC_API_KEY - claude code
#   GOOGLE_API_KEY - gemini TTS (for audio generation)
#   PLYR_BOT_TOKEN - plyr.fm developer token (for audio upload)

name: status maintenance

on:
  # TODO: restore schedule after testing
  # schedule:
  #   - cron: "0 9 * * 1" # every monday 9am UTC
  workflow_dispatch:
    inputs:
      skip_audio:
        description: "skip audio generation"
        type: boolean
        default: false
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  # phase 1: archive + generate audio + open PR
  maintain:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v4

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Bash,Fetch"
          prompt: |
            you are maintaining the plyr.fm (pronounced "player FM") project status file.

            ## critical rules

            1. STATUS.md MUST be kept under 250 lines. this is non-negotiable.
            2. archive content MUST be moved to .status_history/, not deleted
            3. podcast tone MUST be dry, matter-of-fact, slightly sardonic - NOT enthusiastic or complimentary

            ## task 1: gather temporal context

            run these commands:
            ```bash
            date
            git log --oneline --since="1 week ago"
            git log --oneline -30
            ls -la .status_history/ 2>/dev/null || echo "no archive directory yet"
            wc -l STATUS.md
            ```

            determine:
            - what is today's date?
            - what shipped in the last week vs earlier?
            - does .status_history/ exist?
            - how many lines is STATUS.md currently?
            - is this the FIRST episode (no .status_history/ exists)?

            ## task 2: archive old sections (MANDATORY if over 250 lines)

            if STATUS.md > 250 lines:
            1. create .status_history/ directory if it doesn't exist
            2. identify section boundaries (look for "---" separators and "### " headers with dates)
            3. move OLDEST sections to .status_history/YYYY-MM.md (grouped by month)
            4. keep ONLY the most recent content totaling ~200-250 lines in STATUS.md
            5. preserve the document structure (keep "## recent work" header, "## immediate priorities", etc)
            6. do NOT summarize archived content - move it verbatim

            example: if STATUS.md has sections from Nov 10, Nov 12, Nov 24, Nov 27, Dec 1:
            - move Nov 10-24 content to .status_history/2025-11.md
            - keep Nov 27 and Dec 1 content in STATUS.md

            VERIFY: run `wc -l STATUS.md` after archiving. it MUST be under 250 lines.

            ## task 3: generate audio overview

            skip_audio input: ${{ inputs.skip_audio }}

            if skip_audio is false:

            ### understand the project first

            before writing the script, read:
            - STATUS.md (the current state)
            - docs/deployment/overview.md if it exists
            - Fetch https://atproto.com/guides/overview to understand ATProto primitives
            - Fetch https://atproto.com/guides/lexicon to understand NSIDs and lexicons

            this context helps you explain things accurately without over-simplifying.

            ### determine episode type

            check if .status_history/ directory exists:
            - if NO .status_history/ exists: this is the INAUGURAL episode
            - if .status_history/ exists: this is a SUBSEQUENT episode

            ### write the podcast script

            write to podcast_script.txt with "Host: ..." and "Cohost: ..." lines.

            INAUGURAL EPISODE (first time):
            - introduce what plyr.fm is: decentralized music streaming on ATProto
            - explain the core value prop: your music data lives in your PDS, portable between apps
            - cover the technical foundation that's been built (summarize from STATUS.md)
            - set expectations: this is an early-stage project, rough edges exist
            - tone: "here's what we're building and why it matters"

            SUBSEQUENT EPISODES:
            - focus on what actually shipped since last episode
            - use git history to determine timing ("last week" vs "earlier this month")
            - don't re-explain the whole project - listeners already know
            - tone: "here's what changed"

            ### tone requirements (CRITICAL)

            the hosts should sound like two engineers who:
            - are mildly amused by the absurdity of building things
            - acknowledge problems and limitations honestly
            - don't use superlatives ("amazing", "incredible", "exciting")
            - don't congratulate the project or its creator
            - explain technical concepts through analogy, not hype
            - are slightly sardonic but not mean

            BAD example:
            "Host: Wow, they've done an incredible job building this decentralized music platform!"
            "Cohost: Absolutely! The ATProto integration is amazing!"

            GOOD example:
            "Host: So someone built a music streaming thing on ATProto."
            "Cohost: Right, the protocol Bluesky uses. The idea being your playlists and play history live in your personal data server instead of Spotify's database."
            "Host: Which means if plyr.fm disappears tomorrow, you still have your data."
            "Cohost: In theory. Whether anyone else builds a client that reads it is another question."

            forbidden phrases:
            - "exciting", "amazing", "incredible", "impressive", "great job"
            - "the team has done", "they've really", "fantastic work"
            - any variation of congratulating or praising the project

            pronunciation: "plyr.fm" = "player FM" (not "plir" or spelled out)

            target length: 2-3 minutes spoken (~300-400 words)

            ### generate audio

            run: uv run scripts/generate_tts.py podcast_script.txt update.wav
            then: rm podcast_script.txt

            ## task 4: open PR

            if any files changed:
            1. git checkout -b status-maintenance-$(date +%Y%m%d)
            2. git add .status_history/ STATUS.md update.wav
            3. git commit -m "chore: weekly status maintenance"
            4. git push -u origin status-maintenance-$(date +%Y%m%d)
            5. gh pr create --title "chore: weekly status maintenance" --body "automated status archival and audio overview"

            if nothing changed, report that no maintenance was needed.

        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

  # phase 2: upload audio after PR merge
  upload-audio:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'status-maintenance-')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4

      - name: Upload audio to plyr.fm
        run: |
          if [ -f update.wav ]; then
            uv run --with plyrfm -- plyrfm upload update.wav "plyr.fm update - $(date +'%B %d, %Y')" --album "$(date +%Y)"
          else
            echo "No update.wav found, skipping upload"
          fi
        env:
          PLYR_TOKEN: ${{ secrets.PLYR_BOT_TOKEN }}
