openapi: 3.1.0
info:
  title: plyr.fm API
  description: |
    public API for plyr.fm - music streaming on AT Protocol.

    ## authentication

    the API supports two authentication methods:

    1. **API keys** (recommended for integrations):
       ```
       Authorization: Bearer plyr_sk_live_abc123...
       ```

    2. **session cookies** (browser clients):
       cookies are set automatically via `/auth/exchange`

    ## rate limits

    | tier | requests/minute | requests/day |
    |------|-----------------|--------------|
    | anonymous | 30 | 1,000 |
    | authenticated | 100 | 10,000 |
    | verified | 300 | 50,000 |

    rate limit headers are included in all responses:
    - `X-RateLimit-Limit`
    - `X-RateLimit-Remaining`
    - `X-RateLimit-Reset`

    ## pagination

    list endpoints use cursor-based pagination:
    ```json
    {
      "items": [...],
      "cursor": "eyJvZmZzZXQiOjI1fQ==",
      "has_more": true
    }
    ```

    pass the cursor to get the next page:
    ```
    GET /v1/items?cursor=eyJvZmZzZXQiOjI1fQ==
    ```
  version: 1.0.0
  contact:
    name: plyr.fm
    url: https://plyr.fm
  license:
    name: MIT

servers:
  - url: https://api.plyr.fm/v1
    description: production
  - url: https://api-stg.plyr.fm/v1
    description: staging

tags:
  - name: items
    description: content items (tracks, voice memos, etc.)
  - name: artists
    description: artist profiles
  - name: albums
    description: album collections
  - name: me
    description: authenticated user context
  - name: search
    description: discovery and search

paths:
  /items:
    get:
      operationId: listItems
      summary: list items
      description: |
        list all items, optionally filtered by type or artist.
        results are ordered by creation time (newest first).
      tags: [items]
      parameters:
        - name: type
          in: query
          description: filter by item type
          schema:
            type: string
            enum: [track, voice_memo, snippet]
        - name: artist
          in: query
          description: filter by artist handle
          schema:
            type: string
        - name: limit
          in: query
          description: max items to return
          schema:
            type: integer
            default: 25
            maximum: 100
        - name: cursor
          in: query
          description: pagination cursor
          schema:
            type: string
      responses:
        "200":
          description: list of items
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ItemList"
        "429":
          $ref: "#/components/responses/RateLimited"

  /items/{id}:
    get:
      operationId: getItem
      summary: get item by id
      tags: [items]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: item details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Item"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      operationId: updateItem
      summary: update item metadata
      description: update title, album, or other metadata. requires ownership.
      tags: [items]
      security:
        - apiKey: []
        - session: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ItemUpdate"
      responses:
        "200":
          description: updated item
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Item"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      operationId: deleteItem
      summary: delete item
      description: permanently delete an item. requires ownership.
      tags: [items]
      security:
        - apiKey: []
        - session: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: item deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /artists:
    get:
      operationId: listArtists
      summary: list artists
      tags: [artists]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 25
            maximum: 100
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        "200":
          description: list of artists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ArtistList"

  /artists/{handle}:
    get:
      operationId: getArtist
      summary: get artist by handle
      tags: [artists]
      parameters:
        - name: handle
          in: path
          required: true
          description: artist's ATProto handle (e.g., "artist.bsky.social")
          schema:
            type: string
      responses:
        "200":
          description: artist profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Artist"
        "404":
          $ref: "#/components/responses/NotFound"

  /artists/{handle}/items:
    get:
      operationId: listArtistItems
      summary: list artist's items
      tags: [artists]
      parameters:
        - name: handle
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          schema:
            type: string
            enum: [track, voice_memo, snippet]
        - name: limit
          in: query
          schema:
            type: integer
            default: 25
            maximum: 100
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        "200":
          description: artist's items
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ItemList"
        "404":
          $ref: "#/components/responses/NotFound"

  /albums:
    get:
      operationId: listAlbums
      summary: list albums
      tags: [albums]
      parameters:
        - name: artist
          in: query
          description: filter by artist handle
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 25
            maximum: 100
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        "200":
          description: list of albums
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AlbumList"

  /albums/{id}:
    get:
      operationId: getAlbum
      summary: get album by id
      tags: [albums]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: album details with items
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AlbumDetail"
        "404":
          $ref: "#/components/responses/NotFound"

  /me:
    get:
      operationId: getMe
      summary: get current user
      description: returns the authenticated user's profile
      tags: [me]
      security:
        - apiKey: []
        - session: []
      responses:
        "200":
          description: current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /me/items:
    get:
      operationId: listMyItems
      summary: list my items
      description: returns items owned by the authenticated user
      tags: [me]
      security:
        - apiKey: []
        - session: []
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [track, voice_memo, snippet]
        - name: limit
          in: query
          schema:
            type: integer
            default: 25
            maximum: 100
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        "200":
          description: user's items
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ItemList"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /me/likes:
    get:
      operationId: listMyLikes
      summary: list liked items
      tags: [me]
      security:
        - apiKey: []
        - session: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 25
            maximum: 100
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        "200":
          description: liked items
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ItemList"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /me/likes/{item_id}:
    put:
      operationId: likeItem
      summary: like an item
      tags: [me]
      security:
        - apiKey: []
        - session: []
      parameters:
        - name: item_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: like created
          content:
            application/json:
              schema:
                type: object
                properties:
                  liked:
                    type: boolean
                    example: true
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      operationId: unlikeItem
      summary: unlike an item
      tags: [me]
      security:
        - apiKey: []
        - session: []
      parameters:
        - name: item_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: like removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  liked:
                    type: boolean
                    example: false
        "401":
          $ref: "#/components/responses/Unauthorized"

  /search:
    get:
      operationId: search
      summary: search items, artists, albums
      tags: [search]
      parameters:
        - name: q
          in: query
          required: true
          description: search query
          schema:
            type: string
            minLength: 2
        - name: type
          in: query
          description: filter results by type
          schema:
            type: string
            enum: [item, artist, album]
        - name: limit
          in: query
          schema:
            type: integer
            default: 25
            maximum: 100
      responses:
        "200":
          description: search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchResults"
        "429":
          $ref: "#/components/responses/RateLimited"

  /upload/presigned:
    post:
      operationId: getPresignedUrl
      summary: get presigned upload URL
      description: |
        request a presigned URL for direct upload to storage.
        the returned URL is valid for 1 hour.
      tags: [items]
      security:
        - apiKey: []
        - session: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PresignedUrlRequest"
      responses:
        "200":
          description: presigned URL
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PresignedUrlResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /upload/complete:
    post:
      operationId: completeUpload
      summary: complete upload
      description: |
        finalize an upload after the file has been uploaded to the presigned URL.
        returns a job ID for tracking processing status.
      tags: [items]
      security:
        - apiKey: []
        - session: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CompleteUploadRequest"
      responses:
        "202":
          description: upload accepted, processing
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadJobResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "400":
          $ref: "#/components/responses/BadRequest"

components:
  securitySchemes:
    apiKey:
      type: http
      scheme: bearer
      description: API key (plyr_sk_live_... or plyr_sk_test_...)
    session:
      type: apiKey
      in: cookie
      name: session_id
      description: session cookie (browser clients)

  schemas:
    Item:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [track, voice_memo, snippet]
        title:
          type: string
        artist:
          $ref: "#/components/schemas/ArtistRef"
        album:
          $ref: "#/components/schemas/AlbumRef"
        media_url:
          type: string
          format: uri
        image_url:
          type: string
          format: uri
        duration_ms:
          type: integer
        play_count:
          type: integer
        like_count:
          type: integer
        comment_count:
          type: integer
        is_liked:
          type: boolean
          description: only present when authenticated
        created_at:
          type: string
          format: date-time
        atproto:
          $ref: "#/components/schemas/AtprotoRef"
      required:
        - id
        - type
        - title
        - artist
        - created_at

    ItemList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Item"
        cursor:
          type: string
        has_more:
          type: boolean
      required:
        - items
        - has_more

    ItemUpdate:
      type: object
      properties:
        title:
          type: string
          maxLength: 200
        album_id:
          type: string
          format: uuid

    Artist:
      type: object
      properties:
        did:
          type: string
          description: ATProto DID
        handle:
          type: string
          description: ATProto handle
        display_name:
          type: string
        bio:
          type: string
        avatar_url:
          type: string
          format: uri
        item_count:
          type: integer
        created_at:
          type: string
          format: date-time
      required:
        - did
        - handle
        - created_at

    ArtistRef:
      type: object
      properties:
        did:
          type: string
        handle:
          type: string
        display_name:
          type: string
        avatar_url:
          type: string
          format: uri
      required:
        - did
        - handle

    ArtistList:
      type: object
      properties:
        artists:
          type: array
          items:
            $ref: "#/components/schemas/Artist"
        cursor:
          type: string
        has_more:
          type: boolean
      required:
        - artists
        - has_more

    Album:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        slug:
          type: string
        description:
          type: string
        artist:
          $ref: "#/components/schemas/ArtistRef"
        image_url:
          type: string
          format: uri
        item_count:
          type: integer
        total_plays:
          type: integer
        created_at:
          type: string
          format: date-time
      required:
        - id
        - title
        - slug
        - artist
        - created_at

    AlbumRef:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        slug:
          type: string
        image_url:
          type: string
          format: uri

    AlbumList:
      type: object
      properties:
        albums:
          type: array
          items:
            $ref: "#/components/schemas/Album"
        cursor:
          type: string
        has_more:
          type: boolean
      required:
        - albums
        - has_more

    AlbumDetail:
      allOf:
        - $ref: "#/components/schemas/Album"
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: "#/components/schemas/Item"

    User:
      type: object
      properties:
        did:
          type: string
        handle:
          type: string
        display_name:
          type: string
        avatar_url:
          type: string
          format: uri
        is_artist:
          type: boolean
          description: whether user has uploaded content
      required:
        - did
        - handle

    AtprotoRef:
      type: object
      properties:
        uri:
          type: string
          description: at:// URI
        cid:
          type: string
          description: content ID

    SearchResults:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Item"
        artists:
          type: array
          items:
            $ref: "#/components/schemas/Artist"
        albums:
          type: array
          items:
            $ref: "#/components/schemas/Album"

    PresignedUrlRequest:
      type: object
      properties:
        filename:
          type: string
          description: original filename
        content_type:
          type: string
          description: MIME type (audio/mpeg, audio/wav, etc.)
        size:
          type: integer
          description: file size in bytes
      required:
        - filename
        - content_type
        - size

    PresignedUrlResponse:
      type: object
      properties:
        upload_id:
          type: string
        presigned_url:
          type: string
          format: uri
        expires_at:
          type: string
          format: date-time
      required:
        - upload_id
        - presigned_url
        - expires_at

    CompleteUploadRequest:
      type: object
      properties:
        upload_id:
          type: string
        title:
          type: string
        album_id:
          type: string
          format: uuid
      required:
        - upload_id
        - title

    UploadJobResponse:
      type: object
      properties:
        job_id:
          type: string
        status:
          type: string
          enum: [pending, processing, completed, failed]
      required:
        - job_id
        - status

    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            status:
              type: integer
            details:
              type: object
            docs_url:
              type: string
              format: uri
          required:
            - code
            - message
            - status
        request_id:
          type: string
      required:
        - error

  responses:
    BadRequest:
      description: invalid request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: invalid_request
              message: invalid request body
              status: 400

    Unauthorized:
      description: authentication required
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: unauthorized
              message: authentication required
              status: 401

    Forbidden:
      description: insufficient permissions
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: forbidden
              message: you do not have permission to access this resource
              status: 403

    NotFound:
      description: resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: not_found
              message: the requested resource does not exist
              status: 404

    RateLimited:
      description: rate limit exceeded
      headers:
        Retry-After:
          schema:
            type: integer
          description: seconds until rate limit resets
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: rate_limited
              message: too many requests
              status: 429
