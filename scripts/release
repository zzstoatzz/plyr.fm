#!/usr/bin/env -S uv run --script --quiet
# /// script
# requires-python = ">=3.12"
# dependencies = []
# ///
"""create a github release using timestamp-based versioning

version format: YYYY.MMDD.HHMMSS (e.g., 2025.1106.134523)

usage:
    just release
    ./scripts/release
"""

import subprocess
import sys
from datetime import UTC, datetime


def main() -> int:
    """create release with timestamp version."""
    # ensure we're on main branch
    result = subprocess.run(
        ["git", "branch", "--show-current"],
        capture_output=True,
        text=True,
        check=True,
    )
    current_branch = result.stdout.strip()

    if current_branch != "main":
        print(f"âŒ must be on main branch (currently on {current_branch})")
        return 1

    # ensure working directory is clean
    result = subprocess.run(
        ["git", "status", "--porcelain"],
        capture_output=True,
        text=True,
        check=True,
    )
    if result.stdout.strip():
        print("âŒ working directory has uncommitted changes")
        return 1

    version = datetime.now(UTC).strftime("%Y.%m%d.%H%M%S")

    print(f"ğŸš€ creating release {version}")
    print("ğŸ“ tagging main and pushing to prd-frontend branch")

    # create tag on main
    subprocess.run(["git", "tag", version], check=True)
    subprocess.run(["git", "push", "origin", version], check=True)

    # update prd-frontend branch to match main
    subprocess.run(["git", "fetch", "origin"], check=True)
    subprocess.run(["git", "push", "origin", "main:prd-frontend", "--force"], check=True)

    print(f"âœ… release {version} tagged")
    print("ğŸš¢ production deployment starting automatically via prd-frontend branch...")

    return 0


if __name__ == "__main__":
    sys.exit(main())
